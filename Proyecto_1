#include <Arduino.h>

/************************** Configuration ***********************************/

#include "config.h"
portMUX_TYPE mux = portMUX_INITIALIZER_UNLOCKED;

// Variables globales

#define boton 34 // Botón
#define temperatura 35 // Sensor temperatura
#define ADC_VREF_mV    3300.0 // in millivolt
#define ADC_RESOLUTION 4096.0
#define ledrojo 23
#define ledverde 22
#define ledazul 21

volatile bool boton_pressed = false;
float temp = 0;

// Prototipos de funciones
void enviar_temp(float t);
float leer_temp(void);
void color(int R, int G, int B);

// set up de los feeds
AdafruitIO_Feed *temp_ = io.feed("temperatura");

// Interrupción 
void IRAM_ATTR B_isr() {
  portENTER_CRITICAL_ISR(&mux);
    boton_pressed = true;
  portEXIT_CRITICAL_ISR(&mux);
}

void setup() {

  // inicia la conexión serial
  Serial.begin(115200);

  while(! Serial);
  Serial.print("Connecting to Adafruit IO");
  // conectarse a io.adafruit.com
  io.connect();

  // esperar a que se conecte
  while(io.status() < AIO_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  
  Serial.println();
  Serial.println(io.statusText());

  pinMode(boton, INPUT_PULLDOWN);
  attachInterrupt(boton, B_isr, RISING);

}

void loop() {

  io.run();
  
  if (boton_pressed) {
    //se lee el sensor de temperatura
    temp = leer_temp();
    //Funciones para enviar los datos al dashboard
    enviar_temp(temp);
    //Cambia el color del led según el valor de temp
    if (temp < 37.00) {
      color(0,255,0);
    } else if (37.00 < temp < 37.50) {
      color(255,255,0);
    } else {
      color(255,0,0);
    }
    boton_pressed = false;
  }

  delay(3000);

}

// Otras funciones

float leer_temp(void) {
  // lee el valor ADC
  int adcVal = analogRead(temperatura);
  //  convierte el valor ADC a voltaje (mV)
  float milliVolt = adcVal * (ADC_VREF_mV / ADC_RESOLUTION);
  // convierte el voltaje a °C
  float tempC = milliVolt / 10;
  return (tempC);
}

void enviar_temp(float t) {
  Serial.print("sending -> ");
  Serial.println(t);
  temp_->save(t);
}

void color(int R, int G, int B) {
  analogWrite(ledrojo,   R);
  analogWrite(ledverde, G);
  analogWrite(ledazul,  B);
}
